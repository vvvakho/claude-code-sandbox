(version 1)

;; Based on Para Sandboxing Profile - Standard - https://github.com/2mawi2/para/blob/218259b6e260be43334f308a74108f31920f7ca4/src/core/sandbox/profiles/standard.sb
;; Forbids reading HOME_DIR except for cwd (TARGET_DIR)
;; Forbids writing other than to cwd (TARGET_DIR)
;; All network is allowed

;; Deny everything by default
(deny default)

;; Allow network access (required for Claude API)
(allow network*)

;; Deny reading files anywhere on host (allow rules override this below)
(deny file-read*)

(deny file-read*
  (subpath "/")
  (subpath "/Users")
  (subpath (param "HOME_DIR"))
  (subpath (string-append (param "HOME_DIR") "/.ssh"))
)

;; allow directories required to launch claude-code
(allow file-read*
  (subpath "/usr")
  (subpath "/bin")
  (subpath "/opt")
  (subpath "/var")
  (subpath "/private/var")
  (subpath "/nix"))

;; === IMPORTANT === MODIFY this section to include ALL directories leading to claude workdir ===
;; for some reason claude-code needs list access to all parent directories of TARGET_DIR
;; - it doesn't need access to read the contents of directories, only the directories
;; themselves. Otherwise it will set PATH to "" and disable colored output
(allow file-read*
  (literal "/")
  (literal "/Users")
  (literal (param "HOME_DIR"))
  (literal (string-append (param "HOME_DIR") "/src")))

(allow file-read*
    ;; Git configuration (for commits)
    (subpath (string-append (param "HOME_DIR") "/.config/git"))
    (literal (string-append (param "HOME_DIR") "/.gitconfig"))
)

;; Allow process execution and forking (children inherit policy)
(allow process-exec)
(allow process-fork)
;; Essential permissions - based on Chrome sandbox policy
;; Process permissions - from https://github.com/anthropic-experimental/sandbox-runtime/blob/1bafa66a2c3ebc52569fc0c1a868e85e778f66a0/src/sandbox/macos-sandbox-utils.ts#L200
(allow process-info* (target same-sandbox))
;; Allow signals to all children
(allow signal (target same-sandbox))
(allow mach-priv-task-port (target same-sandbox))

;; User preferences - from https://github.com/anthropic-experimental/sandbox-runtime/blob/1bafa66a2c3ebc52569fc0c1a868e85e778f66a0/src/sandbox/macos-sandbox-utils.ts#L200
;; (allow user-preference-read) ;; doesn't seem to be required by claude-code

;; Allow read access to system information
;; From Chromium's sandbox policy for macOS
(allow sysctl-read
    (sysctl-name "hw.activecpu")
    (sysctl-name "hw.busfrequency_compat")
    (sysctl-name "hw.byteorder")
    (sysctl-name "hw.cacheconfig")
    (sysctl-name "hw.cachelinesize_compat")
    (sysctl-name "hw.cpufamily")
    (sysctl-name "hw.cpufrequency_compat")
    (sysctl-name "hw.cputype")
    (sysctl-name "hw.l1dcachesize_compat")
    (sysctl-name "hw.l1icachesize_compat")
    (sysctl-name "hw.l2cachesize_compat")
    (sysctl-name "hw.l3cachesize_compat")
    (sysctl-name "hw.logicalcpu_max")
    (sysctl-name "hw.machine")
    (sysctl-name "hw.ncpu")
    (sysctl-name "hw.pagesize_compat")
    (sysctl-name "hw.physicalcpu_max")
    (sysctl-name "hw.tbfrequency_compat")
    (sysctl-name "kern.hostname")
    (sysctl-name "kern.maxfilesperproc")
    (sysctl-name "kern.osproductversion")
    (sysctl-name "kern.osrelease")
    (sysctl-name "kern.ostype")
    (sysctl-name "kern.osversion")
    (sysctl-name "kern.secure_kernel")
    (sysctl-name "kern.version")
)

;; Allow file writes to specific paths only
;; Note: file-write* does NOT include file-write-create, so we need both
(allow file-read* file-write* file-write-create
    ;; Project directory - primary workspace
    (subpath (param "TARGET_DIR"))
    
    ;; Temporary directories
    (subpath (param "TMP_DIR"))
    (subpath "/tmp")
    (subpath "/private/tmp")
    (subpath "/var/folders")  ; macOS temp directory root
    (subpath "/private/var/folders")  ; Real path (var is symlink to private/var)
    
    ;; below is from `para`'s' sandbox.sb, but these rules don't work because sandbox-exec uses GLOB 'regexes'
    ;; (regex #"^/var/folders/[^/]+/[^/]+/[^/]+/.*")  ; macOS temp dirs and subdirs
    ;; (regex #"^/private/var/folders/[^/]+/[^/]+/[^/]+/.*")  ; Real path version
    ;; (regex #"^/var/folders/.*")  ; Allow all subdirectories under /var/folders for broader compatibility
    ;; (regex #"^/private/var/folders/.*")  ; Real path version
    
    ;; Cache directory
    (subpath (param "CACHE_DIR"))
    (subpath (string-append (param "HOME_DIR") "/.cache"))
    
    ;; Claude configuration
    (subpath (string-append (param "HOME_DIR") "/.claude"))
    (literal (string-append (param "HOME_DIR") "/.claude.json"))
    (literal (string-append (param "HOME_DIR") "/.claude.json.backup"))
    
    ;; Standard I/O devices
    (literal "/dev/stdout")
    (literal "/dev/stderr")
    (literal "/dev/null")
    (literal "/dev/tty")
    (literal "/dev/ptmx")
    (regex #"^/dev/ttys[0-9]+")
    (regex #"^/dev/pty[0-9]+")
)

;; Allow terminal I/O operations (required for interactive mode)
(allow file-ioctl (regex #"^/dev/tty.*"))

;; File I/O on device files - sandbox-runtime - https://github.com/anthropic-experimental/sandbox-runtime/blob/1bafa66a2c3ebc52569fc0c1a868e85e778f66a0/src/sandbox/macos-sandbox-utils.ts#L200
(allow file-ioctl (literal "/dev/null"))
(allow file-ioctl (literal "/dev/zero"))
(allow file-ioctl (literal "/dev/random"))
(allow file-ioctl (literal "/dev/urandom"))
(allow file-ioctl (literal "/dev/dtracehelper"))
(allow file-ioctl (literal "/dev/tty"))
(allow file-ioctl file-read-data file-write-data
  (require-all
    (literal "/dev/null")
    (vnode-type CHARACTER-DEVICE)
  )
)

;; Allow mach lookups for essential services
(allow mach-lookup
    (global-name "com.apple.sysmond")  ; For process listing
)

;; Allow file attribute operations needed for file creation
;; (allow file-write-setugid)
;; (allow file-write-mode)
;; (allow file-write-owner)
;; (allow file-write-times)
;; (allow file-write-flags)

(allow mach-lookup
  (global-name "com.apple.audio.systemsoundserver")
  (global-name "com.apple.distributed_notifications@Uv3")
  (global-name "com.apple.FontObjectsServer")
  (global-name "com.apple.fonts")
  (global-name "com.apple.logd")
  (global-name "com.apple.lsd.mapdb")
  (global-name "com.apple.PowerManagement.control")
  (global-name "com.apple.system.logger")
  (global-name "com.apple.system.notification_center")
  (global-name "com.apple.trustd.agent")
  (global-name "com.apple.system.opendirectoryd.libinfo")
  (global-name "com.apple.system.opendirectoryd.membership")
  (global-name "com.apple.bsd.dirhelper")
  (global-name "com.apple.securityd.xpc")
  (global-name "com.apple.coreservices.launchservicesd")
)

;; The following is required to get Claude API Key from macOS Keychain (if logged in via /login)

;; Specifically allow login keychain
(allow file-read*
    (literal (string-append (param "HOME_DIR") "/Library/Keychains/login.keychain-db"))
)

;; Critical: Allow communication with securityd (keychain daemon)
(allow mach-lookup
    (global-name "com.apple.SecurityServer")
    (global-name "com.apple.securityd")
    (global-name "com.apple.securityd.xpc")
)
